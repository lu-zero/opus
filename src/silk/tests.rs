use silk::decoder::*;
use entropy::*;
use packet::Packet;

    fn decode(in_slice: &[u8], stereo_out: bool,
              right_outbuf: &[f32], left_outbuf: &[f32]) {
        let p = Packet::from_slice(in_slice).unwrap();

        let mut silk = Silk::new(stereo_out);

        silk.setup(&p);

        for frame in p.frames {
            let mut rd = RangeDecoder::new(frame);

            let _ = silk.decode(&mut rd);
        }

        assert_eq!(&silk.right_outbuf[..], &right_outbuf[..]);
        assert_eq!(&silk.left_outbuf[..], &left_outbuf[..]);
    }

    #[test]
    // First Packet of testvector02
    fn decode_midonly_to_stereo() {
        let in_slice = &[
            24, 0, 117, 35, 193, 30, 132, 212, 10, 126, 208, 7, 81, 52, 218, 159, 252, 5, 41, 239,
            159, 65, 1, 87, 181, 124, 31, 132, 62, 64,
        ];

        let outbuf = vec![
            0.0,
            0.0,
            0.000018067658,
            0.000040303756,
            0.00006217384,
            0.000050676164,
            0.00006882091,
            0.00006251221,
            0.000079100166,
            0.000071366696,
            0.00008358848,
            0.00010954219,
            0.00009314428,
            0.00007471895,
            0.00009187053,
            0.00011543312,
            0.00009968806,
            0.00007717536,
            0.00005688308,
            0.00006992291,
            0.00009155123,
            0.00007225159,
            0.000082283856,
            0.00010369863,
            0.000089072724,
            0.00007039197,
            0.000051477527,
            0.000065270964,
            0.000048930804,
            0.00005775347,
            0.000078105826,
            0.000093486946,
            0.00011695236,
            0.000104911516,
            0.000087843735,
            0.000072130475,
            0.0000893232,
            0.00007565466,
            0.00004729777,
            0.000023753006,
            -0.000003481034,
            0.000007222726,
            -0.00003455881,
            -0.00009271239,
            -0.000066918095,
            -0.000027454684,
            0.000010518399,
            -0.0000254706,
            0.0000049614614,
            -0.00039022753,
            -0.0005224956,
            -0.00047128735,
            -0.00056358863,
            -0.0006580248,
            -0.00068203855,
            -0.00066704734,
            -0.0006456452,
            -0.0005996575,
            -0.0006334914,
            -0.0006084688,
            -0.00062359835,
            -0.00058508565,
            -0.0005228264,
            -0.0004765002,
            -0.0004977702,
            -0.0005371424,
            -0.0005641401,
            -0.0006018564,
            -0.00056627224,
            -0.00060242246,
            -0.0006653947,
            -0.0006363526,
            -0.00067228265,
            -0.00072607934,
            -0.00077472016,
            -0.0007508323,
            -0.00070951204,
            -0.0006736619,
            -0.00070547353,
            -0.00067490665,
            -0.0006116076,
            -0.0005548779,
            -0.0005106908,
            -0.00051649136,
            -0.0004828797,
            -0.00043634523,
            -0.0003942762,
            -0.00039607857,
            -0.0003701741,
            -0.000371713,
            -0.0003464717,
            -0.00034844707,
            -0.0003288207,
            -0.0003371921,
            -0.0003200362,
            -0.0002849602,
            -0.00030087636,
            -0.00027824516,
            -0.00024563857,
            -0.00025836847,
            -0.0002770026,
            -0.00029516904,
            -0.00031652366,
            -0.00029966095,
            -0.0002755761,
            -0.00029857265,
            -0.00028539647,
            -0.00029825774,
            -0.0003229264,
            -0.00034267516,
            -0.00036900686,
            -0.00035476664,
            -0.00033501693,
            -0.0003578332,
            -0.0003442865,
            -0.00035875358,
            -0.00034144567,
            -0.00035179761,
            -0.00037886848,
            -0.00035795642,
            -0.00033369192,
            -0.00035021192,
            -0.00036565852,
            -0.00037517678,
            -0.00036457967,
            -0.00034890795,
            -0.00033583154,
            -0.0003450666,
            -0.0003578865,
            -0.00034270264,
            -0.00034698966,
            -0.00035916705,
            -0.0003708265,
            -0.00036255966,
            -0.0003707815,
            -0.00038588603,
            -0.00039805335,
            -0.00041352137,
            -0.00042772965,
            -0.0004430421,
            -0.00043711794,
            -0.0004272484,
            -0.00041760248,
            -0.0004265278,
            -0.00043894202,
            -0.0004476532,
            -0.00043577352,
            -0.00044231408,
            -0.00043519543,
            -0.0004426892,
            -0.00045720986,
            -0.0004666732,
            -0.00045662167,
            -0.00044183253,
            -0.00043033285,
            -0.00041554883,
            -0.0003991444,
            -0.0004021518,
            -0.0003859062,
            -0.000363729,
            -0.00036794055,
            -0.00035335377,
            -0.00030704716,
            -0.00032831624,
            -0.00031874186,
            -0.00030945305,
            -0.00035139953,
            -0.00027755776,
            -0.00031040065,
            -0.00031451246,
            -0.00031291708,
            -0.00031822757,
            -0.00036744564,
            -0.00030704128,
            -0.00034542562,
            -0.00036296426,
            -0.00036483022,
            -0.00038423264,
            -0.0003941805,
            -0.0003664376,
            -0.00036076238,
            -0.00035452793,
            -0.0003323944,
            -0.00036015123,
            -0.00035394664,
            -0.00035182483,
            -0.00035670222,
            -0.0003617367,
            -0.0003228092,
            -0.000355942,
            -0.0003593549,
            -0.00035908085,
            -0.0003688061,
            -0.00037436158,
            -0.0003863271,
            -0.0003966799,
            -0.00041026337,
            -0.00042153866,
            -0.00043842307,
            -0.00040728808,
            -0.0003582299,
            -0.00037332508,
            -0.00039398205,
            -0.000338237,
            -0.00031311178,
            -0.00028689075,
            -0.00025412143,
            -0.00021913888,
            -0.0002228038,
            -0.00015388099,
            -0.00016105262,
            -0.00009726519,
            -0.00010000902,
            -0.00008408187,
            -0.00006209169,
            -0.000052660682,
            0.0000067388846,
            0.000029670395,
            0.00006542809,
            0.000053659922,
            0.00007506335,
            0.000088867186,
            0.00009480247,
            0.00014607885,
            0.000117823256,
            0.00012417675,
            0.00017139876,
            0.00014227604,
            0.00014138046,
            0.00018449393,
            0.00019616325,
            0.00021080494,
            0.00023250596,
            0.00025279768,
            0.00027799938,
            0.00030531277,
            0.0002840034,
            0.00033773758,
            0.00040656223,
            0.0003562422,
            0.00036952534,
            0.0004232817,
            0.0003956121,
            0.00044202147,
            0.00045867288,
            0.00042758355,
            0.0004768431,
            0.0004921706,
            0.00045787738,
            0.0005025254,
            0.0005157768,
            0.0005241799,
            0.00054180715,
            0.0005563786,
            0.00052613893,
            0.00052395667,
            0.0005599942,
            0.0005590905,
            0.00056636054,
            0.0005729376,
            0.00058212475,
            0.00059331453,
            0.000557559,
            0.00054652675,
            0.0005760184,
            0.0006173439,
            0.00054389605,
            0.0005313912,
            0.00051632815,
            0.0005339546,
            0.00047883834,
            0.00049019617,
            0.00043511493,
            0.00044641914,
            0.0004367338,
            0.00041501003,
            0.000364374,
            0.000331152,
            0.00034666515,
            0.00027492447,
            0.00023972207,
            0.00024224953,
            0.00021756259,
            0.00019639167,
            0.00017851594,
            0.00016501207,
            0.00015369013,
            0.00014687527,
            0.00009163152,
            0.00011311626,
            0.000106089705,
            0.00009617381,
            0.00009553661,
            0.000048387086,
            0.00007897997,
            0.00007687673,
            0.00003113523,
            0.00006030392,
            0.000016340247,
            -0.0000020786729,
            -0.000022103666,
            -0.000048141155,
            -0.00012122062,
            -0.00008128,
            -0.00014473175,
            -0.00013882222,
            -0.00019146306,
            -0.00018190368,
            -0.00018643036,
            -0.0002891976,
            -0.0002361408,
            -0.00029843312,
            -0.00027830145,
            -0.0002879903,
            -0.0002934076,
            -0.00033351593,
            -0.0003498932,
            -0.0003612237,
            -0.00034400827,
            -0.00038435328,
            -0.0003618736,
            -0.0003991937,
            -0.00038086757,
            -0.00040051353,
            -0.00043208967,
            -0.00044373644,
            -0.000417068,
            -0.00038973696,
            -0.00041766578,
            -0.0003853322,
            -0.00038022987,
            -0.00039688247,
            -0.00035251363,
            -0.00037676597,
            -0.0003814074,
            -0.0003698009,
            -0.00033389402,
            -0.00039195863,
            -0.00037793597,
            -0.00039117408,
            -0.00036094044,
            -0.00035158306,
            -0.00032902358,
            -0.0003512097,
            -0.00036278958,
            -0.00031850336,
            -0.0002997689,
            -0.00034405876,
            -0.00029620476,
            -0.00031462678,
            -0.0002742068,
            -0.00031360218,
            -0.0002839408,
            -0.00024859587,
            -0.00025631723,
            -0.0002085692,
            -0.00023808342,
            -0.00019352697,
            -0.000202344,
            -0.000202121,
            -0.0002053329,
            -0.00015825967,
            -0.00016356443,
            -0.00016973377,
            -0.00016889903,
            -0.00014837584,
            -0.00014787487,
            -0.00010911938,
            -0.00008238437,
            -0.00010556641,
            -0.000057263976,
            -0.000036379584,
            -0.00005322733,
            0.0000005010479,
            0.000029535115,
            0.000059450067,
            0.000065109016,
            0.000052581832,
            0.00013207388,
            0.00012951999,
            0.00017732712,
            0.00016627478,
            0.00020370472,
            0.00020061409,
            0.00019981223,
            0.0002452158,
            0.00027158554,
            0.00027266165,
            0.00025877624,
            0.00024592614,
            0.00027438614,
            0.00031528424,
            0.00033861955,
            0.0003117534,
            0.0003384213,
            0.00035331098,
            0.00037478213,
            0.000358395,
            0.00033471006,
            0.00036768438,
            0.00034856432,
            0.00033497758,
            0.00035534197,
            0.00036381785,
            0.00037925263,
            0.00039519335,
            0.0003906512,
            0.0003972133,
            0.0004193461,
            0.00038130264,
            0.00036231562,
            0.00043677297,
            0.00039331318,
            0.00037891854,
            0.00040104223,
            0.00038769856,
            0.00036665238,
            0.00039447664,
            0.0003355762,
            0.000308798,
            0.00034601463,
            0.00028193608,
            0.00025882598,
            0.00023086509,
            0.00017186649,
            0.00018958538,
            0.00023993287,
            0.00020597127,
            0.00020340554,
            0.0002397749,
            0.00015634668,
            0.00018520016,
            0.00014973764,
            0.00010392851,
            0.00010673383,
            0.000077002434,
            0.00007891109,
            0.00004642789,
            0.0000057877733,
            -0.0000031385862,
            -0.000038078528,
            -0.000033914253,
            -0.000033344833,
            -0.00003447271,
            -0.000037464928,
            -0.000036620615,
            -0.00008619548,
            -0.00002655501,
            -0.000018066954,
            -0.00005559528,
            -0.00006443009,
            -0.000053738033,
            -0.000081289276,
            -0.000038029775,
            -0.000021225887,
            -0.000066999884,
            -0.00006602613,
            -0.000050787115,
            -0.000040469444,
            -0.000048672224,
            -0.000020870457,
            -0.000060901293,
            -0.00006710121,
            -0.00007888975,
            -0.00011023259,
            -0.00015817984,
            -0.00011895697,
            -0.00015202575,
            -0.00017670613,
            -0.00019538797,
            -0.00020414621,
            -0.00018765386,
            -0.00021895839,
            -0.0002552592,
            -0.00028966588,
            -0.00030726718,
            -0.00028667695,
            -0.00027067948,
            -0.00030915916,
            -0.00029481357,
        ];

        decode(in_slice, true, &outbuf, &outbuf);
    }

    #[test]
    // First Packet of testvector08
    fn decode_unmix() {
        let in_slice = &[12, 9, 178, 70, 140, 148, 202, 129, 225, 86, 64, 234, 160];
        let right = vec![
    0.0,
    0.00002701117,
    0.000048303198,
    0.00006884026,
    0.0000385869,
    0.00007594532,
    0.00004979196,
    0.000080403195,
    0.00005132884,
    0.00007735115,
    0.000104849874,
    0.00006291426,
    0.000046256202,
    0.00007947949,
    0.000102889244,
    0.00005986393,
    0.000037757258,
    0.000017585764,
    0.0000493664,
    0.00007017855,
    0.00002405231,
    0.000056863744,
    0.00008294645,
    0.00004725504,
    0.000025951815,
    0.0000054149305,
    0.00003965142,
    -0.0000016703914,
    0.000028146218,
    0.000050180864,
    0.000065732085,
    0.000095747004,
    0.00005945634,
    0.000043198073,
    0.000023384904,
    0.00006248026,
    0.000019645982,
    -0.0000141328255,
    -0.000034440323,
    -0.00006514615,
    -0.000027445385,
    -0.00008529465,
    -0.00012651064,
    -0.000074555246,
    -0.000044602937,
    -0.000016317026,
    -0.000070441514,
    -0.0000066870252,
    -0.0002150266,
    -0.0003797998,
    -0.00027074805,
    -0.00035152008,
    -0.00041664584,
    -0.00046383071,
    -0.0004131211,
    -0.0004703398,
    -0.00041907397,
    -0.00028594965,
    -0.0002836588,
    -0.00031874585,
    -0.00023711874,
    -0.000267677,
    -0.0002049809,
    -0.00024235052,
    -0.00018757087,
    -0.00023073469,
    -0.0001721245,
    -0.0002092402,
    -0.00016225711,
    -0.0001987486,
    -0.0001499964,
    -0.00018773323,
    -0.00014108633,
    -0.00008909872,
    -0.00006227259,
    -0.00010247962,
    -0.00013381199,
    -0.000057028294,
    -0.00011289501,
    -0.0001481295,
    -0.00017926776,
    -0.00013800371,
    -0.00017888175,
    -0.00014718024,
    -0.000115891744,
    -0.00009865972,
    -0.00012588227,
    -0.00014533648,
    -0.00015823983,
    -0.0001169622,
    -0.00015542419,
    -0.00012230722,
    -0.00009141508,
    -0.000068696536,
    -0.00003434902,
    -0.000003405161,
    -0.000034427063,
    0.000013745997,
    -0.000013917833,
    0.00002517773,
    -0.000009594136,
    0.000027176982,
    -0.000006826173,
    0.000025878671,
    0.00006104425,
    0.0000761183,
    0.000043645923,
    0.000016591166,
    0.00007020828,
    0.000024037368,
    0.00006161385,
    0.000019607238,
    0.00005222777,
    0.000085446474,
    0.000035877536,
    0.00008139619,
    0.00010465333,
    0.0001321316,
    0.0000911244,
    0.00006948422,
    0.000051440846,
    0.000025125784,
    0.000058851714,
    0.00006679643,
    0.00007917189,
    0.000097577795,
    0.00017788081,
    0.00013449864,
    0.000113731345,
    0.00010559635,
    0.00013815417,
    0.000102875856,
    0.000069948874,
    0.00004959022,
    0.000017785953,
    0.000051436153,
    0.00006287675,
    0.000073632094,
    0.00009297575,
    0.00006125957,
    0.000045362824,
    0.000028204115,
    0.000005843962,
    -0.000021768203,
    -0.00004984023,
    -0.00007661332,
    -0.00010647597,
    -0.00007628251,
    -0.00006148941,
    -0.000046500918,
    -0.00007924863,
    -0.000096379714,
    -0.00010777723,
    -0.0001297998,
    -0.00009537318,
    -0.00007924525,
    -0.000119052376,
    -0.00008138536,
    -0.000050684197,
    -0.000086116626
];
        let left = vec![
    0.0,
    0.000026856527,
    0.000047767004,
    0.0000675792,
    0.000037950907,
    0.00007361174,
    0.00004842155,
    0.00007700742,
    0.000049432798,
    0.00007357977,
    0.00009864361,
    0.000059388796,
    0.000043718006,
    0.0000738314,
    0.000094481584,
    0.0000552968,
    0.000034567776,
    0.000016641621,
    0.000044509583,
    0.000062219304,
    0.000022642611,
    0.00005048268,
    0.00007241323,
    0.00004179756,
    0.00002272755,
    0.000005652104,
    0.000032961525,
    -0.00000012799654,
    0.000023937448,
    0.000042557844,
    0.00005587733,
    0.00007916408,
    0.000050148134,
    0.000035875913,
    0.000020642283,
    0.00004952278,
    0.000016265893,
    -0.000011167162,
    -0.000028078062,
    -0.00005071203,
    -0.000024359058,
    -0.00006738367,
    -0.0000975618,
    -0.00005918362,
    -0.00003496505,
    -0.000014939646,
    -0.000051263658,
    -0.000012917168,
    -0.00016304075,
    -0.00028056273,
    -0.00021020102,
    -0.0002637392,
    -0.0003106788,
    -0.00034155956,
    -0.00030850744,
    -0.00034197696,
    -0.00030341704,
    -0.00021197842,
    -0.00020607849,
    -0.00022497708,
    -0.00017298502,
    -0.00018689412,
    -0.00014804589,
    -0.00016692035,
    -0.00013425323,
    -0.00015746107,
    -0.00012338205,
    -0.00014308868,
    -0.000116070645,
    -0.00013572138,
    -0.0001076234,
    -0.0001280017,
    -0.00009819423,
    -0.00006310858,
    -0.00004586245,
    -0.00007114727,
    -0.00008956536,
    -0.00004445191,
    -0.0000781147,
    -0.00010312785,
    -0.00012252324,
    -0.00009911802,
    -0.00012225151,
    -0.000102652375,
    -0.00008138929,
    -0.000070431,
    -0.000087570676,
    -0.00010111334,
    -0.00010850407,
    -0.00008436676,
    -0.00010592205,
    -0.000085360196,
    -0.000064060914,
    -0.000047518108,
    -0.000024122884,
    -0.000004544596,
    -0.00002127729,
    0.000006974824,
    -0.000007423361,
    0.000015014924,
    -0.0000042315482,
    0.000016521928,
    -0.000002417499,
    0.00001817611,
    0.00004183271,
    0.000051386287,
    0.000030667325,
    0.000014401053,
    0.000045520395,
    0.00001964373,
    0.000040245184,
    0.00001629926,
    0.000036452147,
    0.000056711666,
    0.00002836532,
    0.000056059343,
    0.00007309567,
    0.000089739275,
    0.00006421899,
    0.000048612987,
    0.000035638717,
    0.000019659641,
    0.000040180777,
    0.000046746434,
    0.00005549869,
    0.00007020909,
    0.00011972043,
    0.0000945622,
    0.00007984316,
    0.00007508902,
    0.00009397969,
    0.000071814095,
    0.00004924415,
    0.000034244353,
    0.000014733809,
    0.00003513578,
    0.00004383111,
    0.000051638355,
    0.00006304898,
    0.000043266093,
    0.000031609117,
    0.00001948501,
    0.0000038841035,
    -0.000015206173,
    -0.0000347261,
    -0.000053513744,
    -0.00007213981,
    -0.0000537265,
    -0.00004293768,
    -0.00003414388,
    -0.000054758813,
    -0.00006702926,
    -0.00007552501,
    -0.00008854988,
    -0.000067192654,
    -0.000057248515,
    -0.000080323196,
    -0.000057019606,
    -0.000037682505,
    -0.000057456866
];
        decode(in_slice, true, &right, &left);
    }

    #[test]
    fn lsf_to_lpc() {
        let lsf = vec![
            321i16, 2471, 5904, 9856, 12928, 16000, 19328, 22400, 25728, 28800,
        ];
        let mut lpc = [0.0; 10];

        let reference = [
            1.2307129,
            -0.30419922,
            0.24829102,
            -0.14990234,
            0.10522461,
            -0.13671875,
            0.031982422,
            -0.0871582,
            0.06933594,
            -0.011230469,
        ];

        NB_MB::lsf_to_lpc(&mut lpc, lsf);

        assert_eq!(lpc, reference);
    }
